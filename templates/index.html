{% extends "layout.html" %}
{% block title %}ホーム - 推しメシ{% endblock %}
{% block content %}
    <h1>みんなの推しメシ！</h1>
    
    <div class="posts-container">
        {% for post in posts %}
            <div class="post-card">
                {% if post.image_path %}
                    {% if post.image_path.startswith('https://') %}
                        <img src="{{ post.image_path }}" alt="投稿画像" class="post-image">
                    {% else %}
                        <img src="{{ url_for('static', filename=post.image_path) }}" alt="投稿画像" class="post-image">
                    {% endif %}
                {% endif %}
                <div class="post-content">
                    <h3>{{ post.store_name }}</h3>
                    <div class="post-meta">
                        <span><strong>📍 地域:</strong> {{ post.area }}</span>
                        <span><strong>💰 価格帯:</strong> {{ post.price_range }}</span>
                        <span><strong>👤 投稿者:</strong> {{ post.username }}</span>
                        {% if post.school %}<span><strong>🏫 高校:</strong> {{ post.school }}</span>{% endif %}
                    </div>
                    <div class="post-caption">{{ post.caption }}</div>
                    <div class="post-actions">
                        <button type="button" class="like-button{% if post.id in liked_posts %} liked{% endif %}" data-post-id="{{ post.id }}">
                            <span class="heart-icon">{% if post.id in liked_posts %}❤️{% else %}🤍{% endif %}</span>
                            <span class="like-count">{{ post.like_count }}</span>
                        </button>
                        
                        {% set is_ad_post = (post.user_id == config['ADVERTISER_USER_ID']) or post.google_maps_url %}
                        {% if is_ad_post %}
                          <a class="btn ad-map-clickable" href="{{ url_for('tracking_ad.go', post_id=post.id) }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); return true;">🗺 地図を開く</a>
                          {% if current_user_id() and not has_used_coupon(post.id, current_user_id()) %}
                            <a class="btn ad-coupon-clickable" href="{{ url_for('tracking_ad.coupon', post_id=post.id) }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); return confirm('本当にクーポンを開きますか？\\n\\nクーポンの利用は一回のみで、開いた場合二度と開けません！');">🎟 クーポン表示</a>
                          {% endif %}
                        {% endif %}
                        
                        {% if session.is_admin %}
                            <form method="POST" action="{{ url_for('admin_delete_post', post_id=post.id) }}" 
                                  style="display: inline-block; margin-left: 10px;"
                                  onsubmit="return confirm('この投稿を削除してもよろしいですか？');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="delete-button">🗑️削除</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <p>まだ投稿がありません。</p>
        {% endfor %}
    </div>
{% endblock %}