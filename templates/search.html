{% extends "layout.html" %}
{% block title %}æ¤œç´¢ - æ¨ã—ãƒ¡ã‚·{% endblock %}
{% block content %}
    <h1>ã¿ã‚“ãªã®æ¨ã—ãƒ¡ã‚·ã‚’æ¤œç´¢ ğŸ”</h1>
    
    <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
            <label for="area">ğŸ“ åœ°åŸŸ:</label>
            <input type="text" id="area" name="area" value="{{ search_criteria.area or '' }}" placeholder="ä¾‹: ç”²åºœ">
        </div>
        <div>
            <label for="store_name">ğŸª åº—å:</label>
            <input type="text" id="store_name" name="store_name" value="{{ search_criteria.store_name or '' }}" placeholder="ä¾‹: ã‚«ãƒ•ã‚§">
        </div>
        <div>
            <label for="price_range">ğŸ’° ä¾¡æ ¼å¸¯:</label>
            <select id="price_range" name="price_range">
                {% for option in price_options %}
                    <option value="{{ option }}" {% if option == search_criteria.price_range %}selected{% endif %}>
                        {% if option %}{{ option }}{% else %}æŒ‡å®šãªã—{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="school">ğŸ« é«˜æ ¡:</label>
            <select id="school" name="school">
                {% for option in school_options %}
                    <option value="{{ option }}" {% if option == search_criteria.school %}selected{% endif %}>
                        {% if option %}{{ option }}{% else %}æŒ‡å®šãªã—{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button type="submit">æ¤œç´¢ã™ã‚‹ ğŸ”</button>
        </div>
    </form>

    {% if results %}
        <h2>æ¤œç´¢çµæœ ({{ results|length }}ä»¶) ğŸ“‹</h2>
        <div class="posts-container">
            {% for post in results %}
                <div class="post-card">
                    {% if post.image_path %}
                        <img src="{{ url_for('static', filename=post.image_path) }}" alt="æŠ•ç¨¿ç”»åƒ" class="post-image">
                    {% endif %}
                    <div class="post-content">
                        <h3>{{ post.store_name }}</h3>
                        <div class="post-meta">
                            <strong>ğŸ“ åœ°åŸŸ:</strong> {{ post.area }} | 
                            <strong>ğŸ’° ä¾¡æ ¼å¸¯:</strong> {{ post.price_range }} | 
                            <strong>ğŸ‘¤ æŠ•ç¨¿è€…:</strong> {{ post.username }}
                            {% if post.school %} | <strong>ğŸ« é«˜æ ¡:</strong> {{ post.school }}{% endif %}
                        </div>
                        <div class="post-caption">{{ post.caption }}</div>
                        <div class="post-actions">
                            <button type="button" class="like-button{% if post.id in liked_posts %} liked{% endif %}" data-post-id="{{ post.id }}">
                                <span class="heart-icon">{% if post.id in liked_posts %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                                <span class="like-count">{{ post.like_count }}</span>
                            </button>
                            
                            {% if session.is_admin %}
                                <form method="POST" action="{{ url_for('admin_delete_post', post_id=post.id) }}" 
                                      style="display: inline-block; margin-left: 10px;"
                                      onsubmit="return confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="delete-button">ğŸ—‘ï¸ å‰Šé™¤</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        {% if request.method == 'POST' %}
            <p>æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚°ãƒ«ãƒ¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ğŸ˜”<br>
            åˆ¥ã®æ¡ä»¶ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„ï¼</p>
        {% else %}
            <p>æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ã€ãŠæ°—ã«å…¥ã‚Šã®ã‚°ãƒ«ãƒ¡ã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„ âœ¨</p>
        {% endif %}
    {% endif %}
<!-- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°è¡¨ç¤º -->
<div id="debug-log" style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; padding: 10px; font-size: 12px; max-height: 150px; overflow-y: auto; z-index: 999999; font-family: monospace;">
    <div style="font-weight: bold; margin-bottom: 5px;">ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°:</div>
    <div id="log-content"></div>
</div>

<script>
// ãƒ­ã‚°è¡¨ç¤ºé–¢æ•°
function debugLog(message) {
    const logContent = document.getElementById('log-content');
    const time = new Date().toLocaleTimeString();
    logContent.innerHTML += `<div>[${time}] ${message}</div>`;
    logContent.scrollTop = logContent.scrollHeight;
}

// selectè¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
document.querySelectorAll('select').forEach((select, index) => {
    debugLog(`Select ${index} (${select.name}) found`);
    
    select.addEventListener('touchstart', function(e) {
        debugLog(`Select ${index} touched directly!`);
    }, { passive: true });
    
    select.addEventListener('click', function(e) {
        debugLog(`Select ${index} clicked directly!`);
    });
    
    select.addEventListener('change', function(e) {
        debugLog(`Select ${index} changed to: ${this.value}`);
    });
    
    select.addEventListener('focus', function(e) {
        debugLog(`Select ${index} focused`);
    });
});

// labelè¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
document.querySelectorAll('label').forEach((label, index) => {
    label.addEventListener('click', function(e) {
        debugLog(`Label ${index} clicked`);
    });
});

debugLog('Debug system initialized');
// JavaScriptã‚¤ãƒ™ãƒ³ãƒˆã®å¹²æ¸‰ã‚’ãƒã‚§ãƒƒã‚¯
document.addEventListener('click', function(e) {
    if (e.target.tagName === 'SELECT') {
        debugLog('Document click on select detected - this might be interfering!');
    }
});

document.addEventListener('touchstart', function(e) {
    if (e.target.tagName === 'SELECT') {
        debugLog('Document touchstart on select detected');
    }
});

// main.jsã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
debugLog('Checking for interfering event listeners...');
</script>
{% endblock %}
