{% extends "layout.html" %}
{% block title %}ãƒã‚¤ãƒšãƒ¼ã‚¸{% endblock %}
{% block content %}
    <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
    <p>ã‚ˆã†ã“ãã€<strong>{{ session.username or 'ã‚²ã‚¹ãƒˆ' }}</strong> ã•ã‚“ï¼ ğŸ‰</p>
    
    {% if session.is_admin %}
        <div style="background-color: #fff3cd; padding: 1em; border-radius: 5px; margin-bottom: 1em; border: 1px solid #ffeeba;">
            <h3>ğŸ”§ ç®¡ç†è€…æ©Ÿèƒ½</h3>
            {% if session.is_advertiser %}
                <p>ã‚ãªãŸã¯<strong>ç®¡ç†è€… å…¼ åºƒå‘Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong>ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã§ã™ã€‚</p>
                <div style="background-color: #d4edda; padding: 0.5em; border-radius: 3px; margin-bottom: 1em; border: 1px solid #c3e6cb;">
                    <small>ğŸ“¢ åºƒå‘Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¨©é™ãŒæœ‰åŠ¹ã§ã™</small>
                </div>
            {% else %}
                <p>ã‚ãªãŸã¯ç®¡ç†è€…æ¨©é™ã‚’æŒã£ã¦ã„ã¾ã™ã€‚</p>
            {% endif %}
            
            <!-- ç®¡ç†è€…ã®åå‰å¤‰æ›´ãƒ•ã‚©ãƒ¼ãƒ  -->
            <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å¤‰æ›´</h4>
            <form method="post" action="{{ url_for('update_admin_username') }}" style="margin-bottom: 1em;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" name="new_username" placeholder="æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å" value="{{ session.username or '' }}" maxlength="50" style="flex: 1;" autocomplete="off">
                    <button type="submit" onclick="return confirm('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ');">å¤‰æ›´</button>
                </div>
            </form>

            <div style="margin-top: 1em; padding-top: 1em; border-top: 1px solid #ffeeba;">
                <form method="post" action="{{ url_for('privileged_logout') }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" onclick="return confirm('ç®¡ç†è€…æ¨©é™ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ');" 
                            style="background-color: #dc3545; color: white; padding: 0.5em 1em; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸšª æ¨©é™è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </form>
                <small style="display: block; margin-top: 0.5em; color: #666;">
                    â€»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨æŠ•ç¨¿å±¥æ­´ã¯ä¿æŒã•ã‚Œã¾ã™
                </small>
            </div>
            
            <p><small>â€»ç®¡ç†è€…ã¯æŠ•ç¨¿ç”»é¢ã§å…¨ã¦ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚</small></p>
        </div>
    {% else %}
        <!-- æ§ãˆã‚ãªç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="admin-login-container">
            <button type="button" id="adminLoginBtn" class="admin-login-btn">ğŸ” Admin</button>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ -->
        <div id="adminModal" class="admin-modal">
            <div class="admin-modal-content">
                <div class="admin-modal-header">
                    <h3>ğŸ” ç®¡ç†è€…æ¨©é™ã®å–å¾—</h3>
                    <button type="button" id="closeModal" class="admin-modal-close">&times;</button>
                </div>
                <div class="admin-modal-body">
                    <p>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    <form method="post" action="{{ url_for('admin_login') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="form-group">
                            <input type="password" name="admin_password" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required class="admin-password-input" autocomplete="new-password">
                        </div>
                        <div class="admin-modal-actions">
                            <button type="button" id="cancelBtn" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="btn-submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const adminLoginBtn = document.getElementById('adminLoginBtn');
                const adminModal = document.getElementById('adminModal');
                const closeModal = document.getElementById('closeModal');
                const cancelBtn = document.getElementById('cancelBtn');
                const passwordInput = document.querySelector('input[name="admin_password"]');
    
                // ã‚¢ãƒ‰ãƒŸãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
                if (adminLoginBtn) {
                    adminLoginBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                
                        adminModal.style.display = 'block';
                        document.body.style.overflow = 'hidden';
                
                        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã«
                        if (passwordInput) {
                            setTimeout(() => passwordInput.focus(), 100);
                        }
                    });
                }
    
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
                function closeAdminModal() {
                    adminModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    if (adminLoginBtn) {
                        adminLoginBtn.focus();
                    }
                }
    
                // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
                if (closeModal) {
                    closeModal.addEventListener('click', closeAdminModal);
                }
    
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', closeAdminModal);
                }
    
                // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯
                if (adminModal) {
                    adminModal.addEventListener('click', function(e) {
                        if (e.target === adminModal) {
                            closeAdminModal();
                        }
                    });
                }
    
                // ESCã‚­ãƒ¼
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && adminModal.style.display === 'block') {
                        closeAdminModal();
                    }
                });
    
                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
                const adminForm = adminModal.querySelector('form');
                if (adminForm) {
                    adminForm.addEventListener('submit', function() {
                        document.body.style.overflow = 'auto';
                    });
                }
            });
        </script>
    {% endif %}
    
    <h2>ã‚ãªãŸã®æŠ•ç¨¿å±¥æ­´ ğŸ“</h2>
    <div class="info-note">
        ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãŒå¤±ã‚ã‚Œã¾ã™
    </div>
    <div class="posts-container">
        {% if posts %}
            {% for post in posts %}
                <div class="post-card">
                    {% if post.image_path %}
                        {% if post.image_path.startswith('https://') %}
                            <img src="{{ post.image_path }}" alt="åº—èˆ—ç”»åƒ" class="post-image">
                        {% else %}
                            <img src="{{ url_for('static', filename=post.image_path) }}" alt="åº—èˆ—ç”»åƒ" class="post-image">
                        {% endif %}
                    {% endif %}
                    <div class="post-content">
                        <h3>{{ post.store_name }}</h3>
                        <p class="post-meta">
                            ğŸ“ åœ°åŸŸ: {{ post.area }} | ğŸ’° ä¾¡æ ¼å¸¯: {{ post.price_range }}
                            {% if post.school %} | ğŸ« é«˜æ ¡: {{ post.school }}{% endif %}
                        </p>
                        <p class="post-caption">{{ post.caption }}</p>
                        <p>â¤ï¸ ã„ã„ã­æ•°: {{ post.like_count }}</p>
                        <small>ğŸ“… æŠ•ç¨¿æ—¥æ™‚: {{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') if post.created_at else 'N/A' }}</small>
                        <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}" style="margin-top: 10px;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" onclick="return confirm('æœ¬å½“ã«ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" class="delete-button">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆã‚ã¦ã®æ¨ã—ãƒ¡ã‚·ã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼ âœ¨</p>
        {% endif %}
    </div>
{% endblock %}