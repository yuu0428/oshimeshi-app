{% extends "layout.html" %}
{% block title %}ãƒã‚¤ãƒšãƒ¼ã‚¸{% endblock %}
{% block content %}
    <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
    <p>ã‚ˆã†ã“ãã€<strong>{{ session.username or 'ã‚²ã‚¹ãƒˆ' }}</strong> ã•ã‚“ï¼ ğŸ‰</p>
    
    {% if session.is_admin %}
        <div style="background-color: #fff3cd; padding: 1em; border-radius: 5px; margin-bottom: 1em; border: 1px solid #ffeeba;">
            <h3>ğŸ”§ ç®¡ç†è€…æ©Ÿèƒ½</h3>
            {% if session.is_advertiser %}
                <p>ã‚ãªãŸã¯<strong>ç®¡ç†è€… å…¼ åºƒå‘Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong>ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã§ã™ã€‚</p>
                <div style="background-color: #d4edda; padding: 0.5em; border-radius: 3px; margin-bottom: 1em; border: 1px solid #c3e6cb;">
                    <small>ğŸ“¢ åºƒå‘Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¨©é™ãŒæœ‰åŠ¹ã§ã™</small>
                </div>
            {% else %}
                <p>ã‚ãªãŸã¯ç®¡ç†è€…æ¨©é™ã‚’æŒã£ã¦ã„ã¾ã™ã€‚</p>
            {% endif %}
            
            <!-- ç®¡ç†è€…ã®åå‰å¤‰æ›´ãƒ•ã‚©ãƒ¼ãƒ  -->
            <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å¤‰æ›´</h4>
            <form method="post" action="{{ url_for('update_admin_username') }}" style="margin-bottom: 1em;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" name="new_username" placeholder="æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å" value="{{ session.username or '' }}" maxlength="50" style="flex: 1;">
                    <button type="submit" onclick="return confirm('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ');">å¤‰æ›´</button>
                </div>
            </form>

            <div style="margin-top: 1em; padding-top: 1em; border-top: 1px solid #ffeeba;">
                <form method="post" action="{{ url_for('privileged_logout') }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" onclick="return confirm('ç®¡ç†è€…æ¨©é™ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ');" 
                            style="background-color: #dc3545; color: white; padding: 0.5em 1em; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸšª æ¨©é™è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </form>
                <small style="display: block; margin-top: 0.5em; color: #666;">
                    â€»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨æŠ•ç¨¿å±¥æ­´ã¯ä¿æŒã•ã‚Œã¾ã™
                </small>
            </div>
            
            <p><small>â€»ç®¡ç†è€…ã¯æŠ•ç¨¿ç”»é¢ã§å…¨ã¦ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚</small></p>
        </div>
    {% else %}
        <!-- æ§ãˆã‚ãªç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
        <div style="text-align: right; margin-bottom: 1em;">
            <button type="button" id="adminLoginBtn" style="background-color: #6c757d; color: white; padding: 0.3em 0.6em; font-size: 0.8em; border: none; border-radius: 3px; cursor: pointer;">ğŸ” Admin</button>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ -->
        <div id="adminModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ” ç®¡ç†è€…æ¨©é™ã®å–å¾—</h3>
                    <button type="button" id="closeModal" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">&times;</button>
                </div>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <form method="post" action="{{ url_for('admin_login') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div style="margin-bottom: 15px;">
                        <input type="password" name="admin_password" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="text-align: right;">
                        <button type="button" id="cancelBtn" style="background-color: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" style="background-color: #5cb85c; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ»éè¡¨ç¤ºã®åˆ¶å¾¡
            document.getElementById('adminLoginBtn').addEventListener('click', function() {
                document.getElementById('adminModal').style.display = 'block';
                document.querySelector('#adminModal input[name="admin_password"]').focus();
            });

            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('adminModal').style.display = 'none';
            });

            document.getElementById('cancelBtn').addEventListener('click', function() {
                document.getElementById('adminModal').style.display = 'none';
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('adminModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });

            // Escã‚­ãƒ¼ã§é–‰ã˜ã‚‹
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('adminModal').style.display === 'block') {
                    document.getElementById('adminModal').style.display = 'none';
                }
            });
        </script>
    {% endif %}
    
    <h2>ã‚ãªãŸã®æŠ•ç¨¿å±¥æ­´ ğŸ“</h2>
    <div class="posts-container">
        {% if posts %}
            {% for post in posts %}
                <div class="post-card">
                    {% if post.image_path %}
                        <img src="{{ url_for('static', filename=post.image_path) }}" alt="åº—èˆ—ç”»åƒ" class="post-image">
                    {% endif %}
                    <div class="post-content">
                        <h3>{{ post.store_name }}</h3>
                        <p class="post-meta">
                            ğŸ“ åœ°åŸŸ: {{ post.area }} | ğŸ’° ä¾¡æ ¼å¸¯: {{ post.price_range }}
                            {% if post.school %} | ğŸ« é«˜æ ¡: {{ post.school }}{% endif %}
                        </p>
                        <p class="post-caption">{{ post.caption }}</p>
                        <p>â¤ï¸ ã„ã„ã­æ•°: {{ post.like_count }}</p>
                        <small>ğŸ“… æŠ•ç¨¿æ—¥æ™‚: {{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') if post.created_at else 'N/A' }}</small>
                        <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}" style="margin-top: 10px;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" onclick="return confirm('æœ¬å½“ã«ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" class="delete-button">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆã‚ã¦ã®ãŠã™ã™ã‚ã‚°ãƒ«ãƒ¡ã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼ âœ¨</p>
        {% endif %}
    </div>
{% endblock %}